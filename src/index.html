<!DOCTYPE html>
<!--[if lt IE 7]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class='no-js' lang='en'>
    <!--<![endif]-->
    <head>
        <meta charset='utf-8'>
        <title>WsChat - Demo</title>
        <meta content='WebSocket Chat' name='description'>
        <meta content='chat, websocket, real time chat' name='keywords'>
        <meta content='jorguezz' name='author'>
        <meta content='3 days' name='revisit-after'>

        <link href='/assets/images/apple-touch-icon-144x144.png' rel='apple-touch-icon-precomposed' sizes='144x144'>
        <link href='/assets/images/apple-touch-icon-114x114.png' rel='apple-touch-icon-precomposed' sizes='114x114'>
        <link href='/assets/images/apple-touch-icon-72x72.png' rel='apple-touch-icon-precomposed' sizes='72x72'>
        <link href='/assets/images/apple-touch-icon.png' rel='apple-touch-icon-precomposed'>
        <link href='/assets/images/favicon.ico' rel='shortcut icon'>

        <link href='/css/main.css' media='all' rel='stylesheet' type='text/css'>

        <script src="/bower_components/jquery/dist/jquery.min.js"></script>
        <script src="http://localhost:3000/socket.io/socket.io.js"></script>

    </head>

    <body>


        <header>
          <h1 class='header__logo'>WsChat</h1>
        </header>

        <div id='content'>

            <aside>
                <div class='wschat-header'>
                    <div id="nickname" class="ws__chat__nickname">
                      <form id="set-nickname" class="wrap">
                        <label>Bienvenido: </label>
                        <input type="text" id="nick"/>
                        <!--<p id="nickname-err">Usuario existente</p>-->
                      </form>
                    </div>
                </div>

                <div id="connecting">
                    <div class="wrap">Conectado...</div>
                </div>

                <ul class='wschat-users'>
                  <li class='wschat-user__item'>
                    <h3 class='wschat-user__item__title'>
                      <a href="#">User1</a>
                    </h3>
                  </li>
                  <li class='wschat-user__item'>
                    <h3 class='wschat-user__item__title'>
                      <a href="#">User2</a>
                    </h3>
                  </li>
                  <li class='wschat-user__item'>
                    <h3 class='wschat-user__item__title'>
                      <a href="#">User3</a>
                    </h3>
                  </li>
                  <li class='wschat-user__item'>
                    <h3 class='wschat-user__item__title'>
                      <a href="#">User4</a>
                    </h3>
                  </li>
                </ul>
            </aside>

            <main>
                <div id="messages" class='wschat'>
                    <div id="nicknames"></div>
                    <ul id="lines"></ul>
                </div>

                <div class="wschat__form__message">
                    <form id="send-message" class="wschat__sendmessage">
                        <input class="wschat__sendmessage__input" type="text" id="message" autocomplete="off" />
                        <!--<button>Enviar</button>-->
                    </form>
                </div>

            </main>
        </div>

        <footer>
            <p>
                &copy;
                WsChat
                2015
            </p>
        </footer>

        <!--
        <div id="chat" class="ws__chat">
            <div id="nickname" class="ws__chat__nickname">
              <form id="set-nickname" class="wrap">
                <h3>Bienvenido</h3>
                <label>Usuario: </label>
                <input id="nick"/>
                <p id="nickname-err">Usuario existente</p>
              </form>
            </div>

            <div id="connecting">
              <div class="wrap">Conectado...</div>
            </div>

            <div id="messages" class="ws__chat__messages">
              <div id="nicknames"></div>
              <div id="lines"></div>
            </div>

            <form id="send-message" class="ws__chat__sendmessage">
              <input id="message"/>
              <button>Enviar</button>
            </form>
        </div>
        -->

    </body>

    <script type="text/javascript">
        // socket.io specific code
        var socket = io("http://localhost:3000");

        socket.on('connect', function () {
            console.log('connected!')
            $('#chat').addClass('connected');
        });

        socket.on('announcement', function (msg) {
            $('#lines').append($('<p>').append($('<em>').text(msg)));
        });

        socket.on('nicknames', function (nicknames) {
            $('#nicknames').empty().append($('<span>Online: </span>'));
            for (var i in nicknames) {
                $('#nicknames').append($('<b>').text(nicknames[i]));
            }
        });

        socket.on('user message', message);
        socket.on('reconnect', function () {
            $('#lines').remove();
            message('System', 'Reconectando...');
        });

        socket.on('reconnecting', function () {
            message('System', 'Sin conexion');
        });

        socket.on('error', function (e) {
            message('System', e ? e : 'A unknown error occurred');
        });

        function message (from, msg) {
            $('#lines').append($('<li>')
                .append($('<a>')
                .attr('data-element','nicknames')
                .attr('href','#')
                .attr('class','wschat__item__nickname')
                .text('@'+from)
                .append($('<p>')
                .attr('data-element','lines')
                .attr('class','wschat__item__line')
                .text(msg))));
        }


        // dom manipulation
        $(function () {
            $('#set-nickname').submit(function (ev) {
                socket.emit('nickname', $('#nick').val(), function (set) {
                    if (!set) {
                        clear();
                        return $('#chat').addClass('nickname-set');
                    }
                    $('#nickname-err').css('visibility', 'visible');
                });
                return false;
            });

            $('#send-message').submit(function () {
                message('Yo: ', $('#message').val());
                socket.emit('user message', $('#message').val());
                clear();
                $('#lines').get(0).scrollTop = 10000000;
                return false;
            });

            function clear () {
                $('#message').val('').focus();
            };
        });

    </script>


</html>
